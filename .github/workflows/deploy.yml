name:  Validar y Publicar en GitHub Pages

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Permisos necesarios para publicar en GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Evita despliegues simultáneos
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:

  # ─────────────────────────────────────────
  # JOB 1: VALIDACIONES
  # ─────────────────────────────────────────
  validar:
    name:  Validar Proyecto
    runs-on: ubuntu-latest

    steps:
      - name:  Descargar código
        uses: actions/checkout@v4

      - name:  Verificar que existen los archivos requeridos
        run: |
          echo " Verificando archivos del proyecto..."

          if [ ! -f "index.html" ]; then
            echo " ERROR: No se encontró index.html"
            exit 1
          else
            echo " index.html encontrado"
          fi

          if [ ! -f "estilo.css" ]; then
            echo " ERROR: No se encontró estilo.css"
            exit 1
          else
            echo " estilo.css encontrado"
          fi

          if [ ! -f "script.js" ]; then
            echo " ERROR: No se encontró script.js"
            exit 1
          else
            echo " script.js encontrado"
          fi

          if [ ! -f "README.md" ]; then
            echo "  ADVERTENCIA: No se encontró README.md (recomendado)"
          else
            echo " README.md encontrado"
          fi

      - name:  Verificar que CSS está enlazado en HTML
        run: |
          echo " Verificando enlace de estilo.css en index.html..."
          if grep -q "estilo.css" index.html; then
            echo " estilo.css está correctamente enlazado"
          else
            echo " ERROR: estilo.css no está enlazado en index.html"
            exit 1
          fi

      - name:  Verificar que JS está enlazado en HTML
        run: |
          echo " Verificando enlace de script.js en index.html..."
          if grep -q "script.js" index.html; then
            echo " script.js está correctamente enlazado"
          else
            echo " ERROR: script.js no está enlazado en index.html"
            exit 1
          fi

      - name:  Verificar estructura HTML básica
        run: |
          echo " Verificando estructura básica del HTML..."
          if grep -q "<!DOCTYPE html>" index.html; then
            echo " DOCTYPE declarado correctamente"
          else
            echo " ADVERTENCIA: DOCTYPE no encontrado"
          fi

          if grep -q "<title>" index.html; then
            echo " Etiqueta <title> encontrada"
          else
            echo "  ADVERTENCIA: No se encontró etiqueta <title>"
          fi

          if grep -q "calcularAportes" script.js; then
            echo " Función calcularAportes() encontrada en script.js"
          else
            echo " ERROR: No se encontró la función principal calcularAportes()"
            exit 1
          fi

      - name:  Resumen de validaciones
        run: |
          echo ""
          echo "════════════════════════════════════"
          echo "   TODAS LAS VALIDACIONES PASARON"
          echo "   Listo para desplegar..."
          echo "════════════════════════════════════"

  # ─────────────────────────────────────────
  # JOB 2: DESPLIEGUE (solo en push a main)
  # ─────────────────────────────────────────
  desplegar:
    name:  Publicar en GitHub Pages
    runs-on: ubuntu-latest
    needs: validar  # Solo se ejecuta si las validaciones pasan
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name:  Descargar código
        uses: actions/checkout@v4

      - name:  Configurar GitHub Pages
        uses: actions/configure-pages@v4

      - name:  Empaquetar archivos del sitio
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'   # Sube todo el contenido del repositorio

      - name:  Desplegar en GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name:  Publicación exitosa
        run: |
          echo ""
          echo "════════════════════════════════════════"
          echo "   SITIO PUBLICADO EXITOSAMENTE"
          echo "   URL: ${{ steps.deployment.outputs.page_url }}"
          echo "════════════════════════════════════════"
